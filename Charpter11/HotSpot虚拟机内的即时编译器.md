# HotSpot虚拟机内的即时编译器
&emsp;&emsp;当虚拟机发现某个方法或代码块的运行特别频繁时，就会把这些代码认定为”热点代码“。

&emsp;&emsp;为了提高热点代码的执行效率，在运行时，虚拟机将会把这些代码编译成与本地平台相关的机器码，并进行各种层次的优化，完成这个任务的编译器称为即时编
译器（Just In Time Compiler,即JIT编译器）

&emsp;&emsp;即时编译器编译性能的好坏，代码优化程度的高低是衡量一款商用虚拟机优秀与否的最关键的指标之一，也是虚拟机中最核心且最能体现虚拟机技术水平的部
分。

## 解释器与编译器
&emsp;&emsp;许多主流的商用虚拟机，如HotSpot，J9等，都同时包含解释器与编译器。

&emsp;&emsp;解释器与编译器两者各有优势：当程序需要迅速启动和执行的时候，解释器可以首先发挥作用，省去编译的时间，立即执行。在程序运行后，随着时间的推移，
编译器逐渐发挥作用，把越来越多的代码编译成本地代码之后，可以获取更高的执行效率。

&emsp;&emsp;当程序运行环境中内存资源限制较大，可以使用解释执行节约内存，反之可以使用编译执行来提升效率。

&emsp;&emsp;同时，解释器还可以作为编译器激进优化的逃生门，让编译器选择一些优化手段提升速度，若优化失败，可以通过逆优化退回到解释状态继续执行。

&emsp;&emsp;目前主流的HotSpot虚拟机中，默认采用解释器与其中一个编译器直接配合的方式工作。程序使用哪个编译器，取决于虚拟机运行的模式，HotSpot虚拟机会
根据自身版本与宿主机器的硬件性能自动选择运行模式，用户也可以使用”-client“或”-server“参数去强制指定虚拟机运行在Client模式或Server模式。

&emsp;&emsp;解释器与编译器同时使用的方式称为”混合模式“，用户可以使用参数”-Xint“强制虚拟机运行于”解释模式“，全部代码都由解释器进行执行。

&emsp;&emsp;另外，也可以使用参数”-Xcomp“强制虚拟机运行于”编译模式“，这时将优先采用编译器的范式执行程序。

&emsp;&emsp;为了下程序启动响应速度与运行效率之间达到最佳平衡，HotSpot虚拟机还会逐渐启用分层编译的策略。

&emsp;&emsp;分层编译根据编译器编译、优化的规模与耗时，划分出不同的编译层次，其中包括：
- 第0层，程序解释执行，解释器不开启性能监控功能，可触发第1层编译。
- 第1层，也称为c1编译，将字节码编译为本地代码，进行简单、可靠的优化，如有必要将加入性能监控的逻辑。
- 第2层（或2层以上），也称为C2编译，也是将字节码编译为本地代码，但是会启用一些编译耗时较长的优化，甚至会根据性能监控信息进行一些不可靠的激进优化。

&emsp;&emsp;在虚拟机中习惯将Client Compiler称为c1,将Server Compiler称为C2,实施分层编译后，Client Compiler和Server Compiler将会同时工作，
许多代码都可能会被多次编译，用Client Compiler获取更高的编译速度，用Server Compiler获取更好的编译质量。

## 编译对象与触发条件
&emsp;&emsp;在运行过程中总被即时编译器编译的”热点代码“有两类，即：
- 被多次调用的方法
- 被多次执行的循环体

&emsp;&emsp;对于被多次调用的方法进行优化，由于是由方法调用触发的编译，因此编译器会以整个方法作为编译对象，这种编译也是虚拟机中标准的JIT编译方式。

&emsp;&emsp;对于被多次执行的循环体进行优化，循环体在方法内部，进行优化固然在方法执行过程之中，所以称为栈上替换，简称为OSR编译，即方法栈帧还在栈上，
方法就被替换了。

&emsp;&emsp;判断一段代码是不是热点代码，是不是需要触发即时编译，这样的行为称为热点探测。

&emsp;&emsp;目前主要的热点探测判定方式有两种：
- 基于采样的热点探测：周期性地检查各个线程的栈顶，发现某个方法经常出现在栈顶，那么这个方法就是”热点方法“。基于采样的热点探测的好处是实现简单，高效，还可以很容易地获取方法调用关系，缺点是很难精确地确认一个方法的热度，容易因为受到线程阻塞或别的外界因素的影响而扰乱热点探测。

- 基于计数器的热点探测：采用这种方法的虚拟机会为每个方法建立计数器，统计方法的执行次数，如果执行次数超过一定的阈值就认为它是”热点方法“。这种统计方法实现起来麻烦，需要为每个方法建立并维护计数器，而且不能直接获取到方法的调用关系，但是它的统计结果相对来说更加精确和严谨。

&emsp;&emsp;HotSpot虚拟机中使用的是第二种——基于计数器的热点探测方法。为每个方法准备了两类计数器：方法调用计数器和回边计数器

&emsp;&emsp;方法调用计数器的默认阈值在Client模式下是1500次，在Server模式下是10000次，这个阈值可以通过-XX：CompileThreshold来人为设定。

&emsp;&emsp;回边计数器的作用是统计一个方法中循环体代码执行的次数，在字节码中遇到控制流向后跳转的指令称为”回边“。建立回边计数器统计的目的就是为了触发OSR编译。

&emsp;&emsp;虚拟机运行在Client模式下，回边计数器阈值计算公式为：
- 方法调用计数器阈值 * OSR比率 / 100 
&emsp;&emsp;虚拟机运行在Server模式下，回边计数器阈值计算公式为：
- 方法调用计数器阈值 * （OSR比率 - 解释器监控比率）/ 100 


